/*
 * This file was generated by the Gradle 'init' task.
 *
 * This is a general purpose Gradle build.
 * Learn how to create Gradle builds at https://guides.gradle.org/creating-new-gradle-builds
 */

plugins {
  id "com.github.node-gradle.node" version "3.1.1"
}

allprojects {
  repositories {
    mavenLocal()
    mavenCentral()
  }
}

project.ext.SUBPROJS_TO_IGNORE = [
  'packages'
]
configure(subprojects.findAll { !project.ext.SUBPROJS_TO_IGNORE.contains(it.name) }) {
  apply plugin: "com.github.node-gradle.node" // version "3.0.1"

  def slash = File.separator
  project.ext.PROJDIR = "${project.buildDir.toString()}${slash}${slash}${slash}".replace("${slash}build${slash}${slash}", '')

  task clean(type: Delete) {}

  task compileJS(type: NpmTask) {}
  compileJS.inputs.file('package.json')
  compileJS.inputs.dir('src')


  task build {}
  build.dependsOn ":packages:${project.name}:compileJS"

  task lint(type: NpmTask) {
    args = ['run', 'lint']
  }
  lint.inputs.dir('src')
  lint.outputs.dir('src')
  build.shouldRunAfter ":packages:${project.name}:lint"


  task test(type: NpmTask) {}
  test.inputs.files('package.json')
  test.inputs.dir('src')
  test.inputs.dir('test')
  // test.dependsOn ":packages:${project.name}:npmClean"
  test.dependsOn ":packages:${project.name}:lint"
  test.dependsOn build
  // build.dependsOn npmInstall

  if (project.name !== 'react4xp') {
    npmInstall.enabled = false
  }
}


npmInstall.inputs.files('package.json', 'package-lock.json', 'build.gradle')
npmInstall.outputs.file('package-lock.json')

// Replace npmInstall with npmDoInstall in order to ensure than npmLink is run afterwards!
task npmDoInstall(type: NpmTask) {
  args = ['install']

  inputs.files('package.json', 'package-lock.json', 'build.gradle')
  inputs.files('package.json', 'build.gradle')
}

task clean(type: Delete) {
  delete 'build'
  followSymlinks = false
}

task npmUnlink(type: NpmTask) {
  args = ['run', 'npmUnlink']

  npmInstall.inputs.files('package.json', 'package-lock.json', 'build.gradle')
}
task npmLink(type: NpmTask) {
  args = ['run', 'npmLink']

  npmInstall.inputs.files('package.json', 'package-lock.json', 'build.gradle')
  inputs.files('package.json', 'build.gradle')
}

npmInstall.enabled = false;
npmInstall.dependsOn npmDoInstall
npmDoInstall.dependsOn npmUnlink
// npmLink.mustRunAfter npmDoInstall
//npmInstall.dependsOn npmLink


task setup(type: NpmTask) {
  args = ['run', 'setup']
}

///////////////////////////////////////////////////

apply from: 'versionAndPublish.gradle'


